<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista Kempingów z Mapą</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

  <style>
    body {
      font-family: "Open Sans", sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
    }
    #camping-list {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <ul id="camping-list"></ul>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // URL do pliku KML
    const kmlUrl = "./map.kml";

    // Inicjalizacja mapy
    const map = L.map("map").setView([52.237049, 21.017532], 6);

    // Dodanie warstwy kafelkowej
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Inicjalizacja markerCluster
    const markerCluster = L.markerClusterGroup({
      showCoverageOnHover: false,
      maxClusterRadius: 40,
      iconCreateFunction: function (cluster) {
        const count = cluster.getChildCount();
        let size = "small";
        if (count > 10) size = "medium";
        if (count > 50) size = "large";
        return L.divIcon({
          html: `<div><span>${count}</span></div>`,
          className: `marker-cluster marker-cluster-${size}`,
          iconSize: L.point(40, 40, true),
        });
      },
    });

    const markers = [];

    async function loadCampingList() {
      try {
        // Pobranie pliku KML
        const response = await fetch(kmlUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const kmlText = await response.text();

        // Parsowanie pliku KML
        const parser = new DOMParser();
        const kml = parser.parseFromString(kmlText, "application/xml");

        const placemarks = Array.from(kml.getElementsByTagName("Placemark"));
        const campingList = document.getElementById("camping-list");
        campingList.innerHTML = "";

        // Przetwarzanie każdego placemarkera
        placemarks.forEach((placemark) => {
          const name = placemark.getElementsByTagName("name")[0]?.textContent || "Brak nazwy";
          const coordinates = placemark.getElementsByTagName("coordinates")[0]?.textContent.trim();

          if (coordinates) {
            const [lon, lat] = coordinates.split(",");
            const marker = L.marker([lat, lon]).bindPopup(`<strong>${name}</strong>`);

            markerCluster.addLayer(marker);
            markers.push({ marker, name: name.toLowerCase(), lat, lon });

            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${name}</strong>
              <button data-lat="${lat}" data-lon="${lon}">Pokaż na mapie</button>
            `;
            campingList.appendChild(li);
          }
        });

        map.addLayer(markerCluster);
      } catch (error) {
        console.error("Błąd podczas wczytywania pliku KML:", error);
      }
    }

    // Obsługa kliknięcia na liście
    document.getElementById("camping-list").addEventListener("click", (event) => {
      const button = event.target;
      if (button.tagName === "BUTTON") {
        const lat = button.getAttribute("data-lat");
        const lon = button.getAttribute("data-lon");
        if (lat && lon) {
          const selectedMarker = markers.find(
            (marker) => marker.lat === lat && marker.lon === lon
          );
          if (selectedMarker) {
            map.setView([lat, lon], 18); // Powiększenie mapy do wybranego miejsca
            selectedMarker.marker.openPopup(); // Otwarcie popupu
          }
        }
      }
    });

    // Załaduj listę kempingów
    loadCampingList();
  </script>
</body>
</html>
